<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>浏览器兼容性检测 - 缎金SatinAu</title>
    <link rel="icon" type="image/x-icon" href="https://satinau.cn/favicon.ico">
    <style>
        /* 使用基础CSS，确保IE等旧浏览器也能渲染布局 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { margin-top: 0; font-size: 24px; }
        .browser-info {
            background: #eef2f5;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #007aff;
        }
        .status-header {
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #fff;
            text-align: center;
            font-weight: bold;
        }
        .status-ok { background-color: #34c759; }
        .status-warn { background-color: #ff9500; }
        .status-error { background-color: #ff3b30; }
        .status-unknown { background-color: #8e8e93; }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            font-size: 14px;
        }
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th { background-color: #f9f9f9; }
        .pass { color: #34c759; font-weight: bold; }
        .fail { color: #ff3b30; font-weight: bold; }
        .optional-fail { color: #ff9500; font-weight: bold; } /* 黄色表示非致命的不支持 */
        .btn {
            display: inline-block;
            background-color: #007aff;
            color: white;
            padding: 12px 24px;
            text-decoration: none;
            border-radius: 6px;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn:hover { background-color: #0056b3; }
        .details-box {
            font-size: 13px;
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: #fafafa;
            border-radius: 4px;
        }
    </style>
</head>
<body>

<div class="container">
    <div id="statusHeader" class="status-header status-unknown">
        正在检测...
    </div>

    <h1>兼容性与硬件能力报告</h1>

    <div class="browser-info">
        <strong>当前环境：</strong> <span id="browserName">检测中...</span>
    </div>

    <p>以下检测包含 Web 核心技术支持情况，以及您的设备是否支持 HDR 和广色域显示。</p>

    <table id="featureTable">
        <thead>
            <tr>
                <th>检测项目</th>
                <th>类型</th>
                <th>状态</th>
            </tr>
        </thead>
        <tbody>
            <!-- 表格内容将由 JS 填充 -->
        </tbody>
    </table>

    <div class="details-box">
        <p><strong>说明：</strong></p>
        <ul style="margin: 5px 0 0 0; padding-left: 20px;">
            <li><strong>核心</strong>：不支持会导致网站无法使用。</li>
            <li><strong>视觉</strong>：不支持会降级显示效果（如无毛玻璃、无圆角等），但不影响浏览。</li>
            <li><strong>屏幕</strong>：检测您的显示器是否支持 HDR 或 P3 色域。如不支持，图片颜色可能不够鲜艳或有色差。</li>
        </ul>
    </div>

    <div style="text-align: center; margin-top: 30px;">
        <button onclick="window.history.length > 1 ? window.history.back() : window.close()" class="btn">返回 / 关闭页面</button>
    </div>
</div>

<script>
    // 基础功能检测逻辑 - 不使用 ES6 模块语法
    (function() {
        var features = [
            // 核心与视觉功能
            { name: "CSS 变量 (Custom Properties)", type: "css", prop: "color", val: "var(--c)", level: "core" },
            { name: "CSS Grid 布局", type: "css", prop: "display", val: "grid", level: "core" },
            { name: "ES6 模块 (type=\"module\")", type: "js-module", level: "core" },
            { name: "CSS 嵌套 (Nesting)", type: "css-selector", selector: "&", level: "visual" },
            { name: "CSS :has() 伪类", type: "css-selector", selector: ":has(*)", level: "visual" },
            { name: "backdrop-filter (毛玻璃)", type: "css", prop: "backdrop-filter", val: "blur(10px)", level: "visual" },
            { name: "light-dark() 颜色函数", type: "css", prop: "color", val: "light-dark(black, white)", level: "visual" },
            { name: "CSS @container 容器查询", type: "css-at", rule: "@container (min-width: 1px)", level: "visual" },
            
            // 新增：屏幕/硬件能力检测
            { name: "HDR 屏幕显示 (High Dynamic Range)", type: "media-query", query: "(dynamic-range: high)", level: "screen" },
            { name: "Display P3 广色域", type: "media-query", query: "(color-gamut: p3)", level: "screen" }
        ];

        var results = {
            core: { total: 0, passed: 0 },
            visual: { total: 0, passed: 0 },
            screen: { total: 0, passed: 0 }
        };

        // 1. 获取浏览器信息
        function getBrowserInfo() {
            var ua = navigator.userAgent;
            var tem, M = ua.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i) || [];
            
            // --- IE 检测 ---
            if(/trident/i.test(M[1])){
                tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
                return 'IE '+(tem[1] || '');
            }
            
            // --- Edge / Opera 检测 ---
            if(M[1]=== 'Chrome'){
                tem = ua.match(/\b(OPR|Edge|Edg)\/(\d+)/);
                if(tem!= null) return tem.slice(1).join(' ').replace('OPR', 'Opera').replace('Edg', 'Edge');
            }

            // 整理格式：[名称, 版本]
            M = M[2]? [M[1], M[2]]: [navigator.appName, navigator.appVersion, '-?'];

            if((tem = ua.match(/version\/(\d+)/i))!= null) {
                if (M[0] !== 'Chrome') {
                    M.splice(1, 1, tem[1]);
                }
            }
            
            var browserStr = M.join(' ');

            if (/MicroMessenger/i.test(ua)) {
                browserStr += ' (WeChat)';
            }

            return browserStr;
        }
        document.getElementById('browserName').textContent = getBrowserInfo();

        // 2. 特性检测辅助函数
        function supportsCSS(prop, value) {
            if (window.CSS && window.CSS.supports) {
                return window.CSS.supports(prop, value);
            }
            return false;
        }

        function supportsSelector(selector) {
            if (window.CSS && window.CSS.supports) {
                return window.CSS.supports('selector(' + selector + ')');
            }
            return false;
        }

        function supportsAtRule(rule) {
             if (window.CSS && window.CSS.supports) {
                 try {
                    // 容器查询的代理检测
                    return window.CSS.supports('(container-type: size)'); 
                 } catch(e) { return false; }
             }
             return false;
        }

        // 检测 JS Module
        var jsModuleSupported = false;
        var script = document.createElement('script');
        if ('noModule' in script) { jsModuleSupported = true; }

        // 检测 Media Query (HDR/Color Gamut)
        function supportsMediaQuery(query) {
            if (window.matchMedia) {
                return window.matchMedia(query).matches;
            }
            return false;
        }

        // 3. 执行检测并渲染表格
        var tbody = document.querySelector('#featureTable tbody');
        
        for (var i = 0; i < features.length; i++) {
            var f = features[i];
            var isSupported = false;

            if (f.type === 'css') {
                isSupported = supportsCSS(f.prop, f.val);
            } else if (f.type === 'css-selector') {
                isSupported = supportsSelector(f.selector);
            } else if (f.type === 'css-at') {
                isSupported = supportsAtRule(f.rule);
            } else if (f.type === 'js-module') {
                isSupported = jsModuleSupported;
            } else if (f.type === 'media-query') {
                isSupported = supportsMediaQuery(f.query);
            }

            // 统计
            results[f.level].total++;
            if (isSupported) results[f.level].passed++;

            // 渲染行
            var tr = document.createElement('tr');
            var levelText = '';
            var statusClass = '';
            var statusText = '';

            switch(f.level) {
                case 'core': levelText = '核心技术'; break;
                case 'visual': levelText = '视觉特效'; break;
                case 'screen': levelText = '屏幕硬件'; break;
            }

            if (isSupported) {
                statusClass = 'pass';
                statusText = '支持 / 是';
            } else {
                // 对于屏幕硬件，不支持只显示为警告色，不是错误
                if (f.level === 'screen') {
                    statusClass = 'optional-fail';
                    statusText = '不支持 (SDR)';
                } else {
                    statusClass = 'fail';
                    statusText = '不支持';
                }
            }

            tr.innerHTML = 
                '<td>' + f.name + '</td>' +
                '<td>' + levelText + '</td>' +
                '<td class="' + statusClass + '">' + statusText + '</td>';
            tbody.appendChild(tr);
        }

        // 4. 判定最终结果
        var header = document.getElementById('statusHeader');
        var mainTitle = document.querySelector('h1');
        
        if (results.core.passed < results.core.total) {
            // 核心功能挂了
            header.className = 'status-header status-error';
            header.textContent = '❌ 严重不兼容';
            mainTitle.textContent = '抱歉，您的浏览器过旧，无法正常浏览';
        } else if (results.visual.passed < results.visual.total) {
            // 核心过了，视觉挂了
            header.className = 'status-header status-warn';
            header.textContent = '⚠️ 部分兼容';
            mainTitle.textContent = '浏览器可用，但视觉效果会降级';
        } else {
            // 核心和视觉全过 (不强制要求HDR屏幕)
            header.className = 'status-header status-ok';
            header.textContent = '✅ 完美兼容';
            
            // 如果屏幕支持HDR，给个好评
            if (results.screen.passed === results.screen.total) {
                mainTitle.textContent = '您的设备支持 HDR，将获得最佳体验';
            } else {
                mainTitle.textContent = '浏览器兼容性良好 (当前为 SDR 显示模式)';
            }
        }

    })();
</script>

</body>
</html>