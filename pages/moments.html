<!--
  Copyright 2025 缎金SatinAu

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>动态Moments - 缎金SatinAu</title>
  <meta name="description" content="缎金SatinAu的日常动态与碎碎念">
  <meta name="author" content="缎金SatinAu">
  <meta name="color-scheme" content="light dark">
  <meta name="supported-color-schemes" content="light dark">
  <link rel="canonical" href="https://satinau.cn/pages/moments">
  <link rel="icon" type="image/x-icon" href="https://satinau.cn/favicon.ico">
  <link rel="stylesheet" href="/src/style.css">
  <script src="/src/script/config.js"></script>
  <script src="/src/script/common.js" defer></script>
  <script src="/src/script/components/CRCMenu.js"></script>
  <script src="/src/script/components/GlobalModal.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.css">
  <script src="https://cdn.jsdelivr.net/npm/viewerjs@1.11.6/dist/viewer.min.js"></script>

  <style>
    /* 动态卡片容器 */
    .moments-timeline {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 30px;
      text-align: left; /* 动态内容左对齐更易阅读 */
    }

    /* 单个动态卡片 - 复用 .contact-card 的核心玻璃质感 */
    .moment-card {
      padding: 24px;
      border-radius: var(--border-radius-lg);
      background: light-dark(rgba(255, 255, 255, 0.28), rgba(30, 30, 30, 0.2));
      -webkit-backdrop-filter: blur(24px) saturate(180%);
      backdrop-filter: blur(24px) saturate(180%);
      border: 1px solid light-dark(rgba(255, 255, 255, 0.25), rgba(255,255,255,0.12));
      box-shadow: 0 12px 32px rgba(0,0,0,0.08), inset 0 0 20px rgba(255,255,255,0.08);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      opacity: 0; /* 初始隐藏，用于JS做入场动画 */
      transform: translateY(20px);
    }

    .moment-card:hover {
      box-shadow: 0 16px 48px rgba(0,0,0,0.12);
      background: light-dark(rgba(255, 255, 255, 0.35), rgba(30, 30, 30, 0.3));
    }

    /* 头部：头像与信息 */
    .moment-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }

    .moment-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .moment-info {
      display: flex;
      flex-direction: column;
    }

    .moment-author {
      font-size: 16px;
      font-weight: 600;
      color: var(--word-color);
    }

    .moment-date {
      font-size: 13px;
      color: light-dark(#666, #aaa);
      margin-top: 2px;
    }

    /* 正文 */
    .moment-content {
      font-size: 16px;
      line-height: 1.7;
      color: var(--word-color);
      margin-bottom: 16px;
      &:last-child {
        margin-bottom: 0;
      }
    }

    /* Markdown 生成的 p 标签边距 */
    .moment-content p {
      margin: 0 0 8px 0;
    }
    .moment-content p:last-child {
      margin-bottom: 0;
    }

    /* 自定义链接样式 */
    .moment-content a {
        color: var(--primary-color);
        text-decoration: none;
        font-weight: 500;
        &:hover {
        text-decoration: underline;
        }
    }

    /* 图片网格系统 */
    .moment-gallery {
        display: grid;
        gap: 8px;
        border-radius: var(--border-radius-md);
        overflow: hidden;
        width: fit-content;
        max-width: 100%;

        /* 根据图片数量动态调整 Grid */
        &[data-count="1"] { grid-template-columns: 1fr; }
        &[data-count="2"] { grid-template-columns: 1fr 1fr; }
        &[data-count="3"] { grid-template-columns: 1fr 1fr 1fr; }
        &[data-count="4"] { grid-template-columns: 1fr 1fr; }
        &[data-count="default"] { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }

        img {
            width: 100%;
            height: 100%;
            max-height: 400px; /* 单图最大高度 */
            object-fit: cover;
            border-radius: 8px;
            cursor: zoom-in;
            transition: filter 0.3s ease;
            background: rgba(0,0,0,0.05);

            &:hover {
            filter: brightness(0.9);
            }
            &:active {
                transform: scale(0.98);
            }
        }
    }
    
    /* === 图片容器与动态照片支持 === */
    .moment-img-wrapper {
        position: relative;
        width: 100%;
        height: auto; 
        overflow: hidden;
        border-radius: 8px;
        background: rgba(0,0,0,0.05);
        display: flex; 
        align-items: center; 
        justify-content: center;
    }

    .moment-gallery img {
        max-height: 400px;
        object-fit: cover;
        border-radius: 0; 
        cursor: zoom-in;
        transition: filter 0.3s ease;
        display: block;
    }

    .moment-gallery img:hover {
        filter: brightness(0.9);
    }

    /* 播放后的视频样式 */
    .moment-img-wrapper video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 2;
        border-radius: 8px;
    }

    /* LIVE 标识/按钮 */
    .live-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
        color: rgba(255, 255, 255, 0.9);
        font-size: 10px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 12px;
        cursor: pointer;
        z-index: 3;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s ease;
        border: 1px solid rgba(255,255,255,0.2);
    }

    .live-badge:hover {
        background: rgba(0, 0, 0, 0.6);
        transform: scale(1.05);
    }

    .live-badge svg {
        width: 10px;
        height: 10px;
        fill: currentColor;
    }

    /* 加载中状态 */
    .live-badge.loading {
        pointer-events: none;
        opacity: 0.8;
    }
    .live-badge.loading svg {
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* 移动端优化 */
    @media (max-width: 768px) {
      .moment-card { padding: 18px; }
      .moment-gallery[data-count="3"] { grid-template-columns: 1fr 1fr; }
      .live-badge { padding: 3px 6px; font-size: 9px; }
    }
  </style>
</head>

<body id="moments-page">
  <div class="color-bg color-bg-1"></div>
  <div class="color-bg color-bg-2"></div>
  <div class="color-bg color-bg-3"></div>
  <div class="color-bg color-bg-4"></div>

  <main class="page">
    <header>
      <div class="title-row">
        <h1>动态 Moments</h1>
      </div>
      <div class="greeting" id="greeting"></div>
    </header>

    <section>
      <div id="momentsList" class="moments-timeline">
        </div>
      
      <div id="statusMsg" style="margin-top: 40px; color: #888; font-size: 14px;">
        加载动态中...
      </div>
    </section>

    <script src="/src/script/components/footer.js"></script>
    <site-footer></site-footer>
  </main>

  <div id="loadingOverlay" class="loading-overlay show">
    <div class="spinner"></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script src="/src/script/components/navigate.js"></script>
  <navigate-bar></navigate-bar>

  <script>
    // === 动态照片处理工具类 ===
    class MotionPhotoHelper {
        /**
         * 尝试从 Blob 中提取视频
         * 支持: 
         * 1. Google Pixel (GCamera:MicroVideoOffset)
         * 2. Xiaomi / Redmi / POCO (MiCamera:MicroVideoOffset)
         * 3. Samsung / Generic (Trailer/Append method)
         */
        static async extractVideo(blob) {
            const buffer = await blob.arrayBuffer();
            const uint8 = new Uint8Array(buffer);
            const size = uint8.length;

            // 1. 尝试 XMP 方法 (Google & Xiaomi)
            // 读取头部 64KB 查找 XMP
            const headerLimit = Math.min(65536, size);
            const decoder = new TextDecoder("utf-8");
            const headerText = decoder.decode(uint8.slice(0, headerLimit));
            
            // 匹配正则：支持 Google 和 Xiaomi 的命名空间
            // Google: GCamera:MicroVideoOffset
            // Xiaomi: MiCamera:MicroVideoOffset 或 直接 MicroVideoOffset
            let xmpMatch = /GCamera:MicroVideoOffset="(\d+)"/.exec(headerText);
            
            if (!xmpMatch) {
                // 尝试 Xiaomi 特有的 MiCamera 命名空间
                xmpMatch = /MiCamera:MicroVideoOffset="(\d+)"/.exec(headerText);
            }
            
            if (!xmpMatch) {
                // 尝试宽泛匹配 (防止某些厂商省略命名空间)
                xmpMatch = /MicroVideoOffset="(\d+)"/.exec(headerText);
            }
            
            if (xmpMatch) {
                const videoOffset = parseInt(xmpMatch[1]);
                if (videoOffset > 0 && videoOffset < size) {
                    console.log(`[MotionPhoto] 检测到 XMP 偏移量: ${videoOffset} (Google/Xiaomi)`);
                    return new Blob([uint8.slice(size - videoOffset)], { type: 'video/mp4' });
                }
            }

            // 2. 尝试搜索 MP4 标识 (Samsung / Generic / Old Xiaomi)
            // 从文件末尾向前搜索 'ftyp' 标识
            // 很多小米旧机型和三星直接将 MP4 拼接到文件末尾
            const searchLimit = Math.min(10 * 1024 * 1024, size); // 增加搜索范围到 10MB，以防视频较大
            const searchStart = size - searchLimit;
            
            for (let i = searchStart; i < size - 20; i++) {
                // 检查 'ftyp' (0x66 0x74 0x79 0x70)
                if (uint8[i] === 0x66 && uint8[i+1] === 0x74 && uint8[i+2] === 0x79 && uint8[i+3] === 0x70) {
                    // ftyp 前面应该是 size (Uint32 Big Endian)
                    // MP4 头部结构: [4 bytes size] [4 bytes 'ftyp'] ...
                    const boxSize = (uint8[i-4] << 24) | (uint8[i-3] << 16) | (uint8[i-2] << 8) | uint8[i-1];
                    
                    const possibleStart = i - 4;
                    // 校验：
                    // 1. Box size 应该合理 (通常 > 16)
                    // 2. 视频不应该超出文件尾部太多 (允许少量 Metadata 冗余)
                    if (boxSize > 16 && boxSize < 1000000 && (possibleStart + boxSize) < size + 5000000) {
                        console.log(`[MotionPhoto] 检测到 MP4 头部 (ftyp)`);
                        return new Blob([uint8.slice(possibleStart)], { type: 'video/mp4' });
                    }
                }
            }

            return null;
        }
    }

    // === 全局处理函数 ===
    window.playMotionPhoto = async function(btn, src) {
        // 阻止冒泡
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }

        const wrapper = btn.closest('.moment-img-wrapper');
        const img = wrapper.querySelector('img');
        const originalText = btn.innerHTML;

        // 状态：加载中
        btn.classList.add('loading');
        btn.innerHTML = `
            <svg viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"></path></svg>
            加载中
        `;

        try {
            const response = await fetch(src);
            if (!response.ok) throw new Error('下载失败');
            const blob = await response.blob();

            const videoBlob = await MotionPhotoHelper.extractVideo(blob);

            if (videoBlob) {
                const videoUrl = URL.createObjectURL(videoBlob);
                
                const video = document.createElement('video');
                video.src = videoUrl;
                video.autoplay = true;
                video.loop = true;
                video.muted = false; 
                video.controls = true;
                video.playsInline = true;
                
                video.style.opacity = '0';
                video.style.transition = 'opacity 0.5s ease';
                
                wrapper.appendChild(video);
                
                requestAnimationFrame(() => {
                    video.style.opacity = '1';
                    btn.style.display = 'none'; 
                });

                video.onerror = () => {
                    showToast('视频解析成功但无法播放');
                    video.remove();
                    btn.style.display = 'flex';
                };

            } else {
                showToast('这不是一张包含动态信息的照片');
            }
        } catch (e) {
            console.error(e);
            showToast('动态照片加载失败');
        } finally {
            if (wrapper.querySelector('video') === null) {
                btn.classList.remove('loading');
                btn.innerHTML = originalText;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
      // 修改为 moments.json
      const MOMENTS_API = `${getCdnBaseUrl()}/data/moments.json`;
      const momentsList = document.getElementById('momentsList');
      const statusMsg = document.getElementById('statusMsg');
      const loadingOverlay = document.getElementById('loadingOverlay');

      // 获取数据
      fetch(MOMENTS_API)
        .then(response => {
          if (!response.ok) throw new Error('网络响应异常');
          return response.json();
        })
        .then(data => {
          // 隐藏全屏加载动画
          loadingOverlay.classList.remove('show');
          
          if (!data || data.length === 0) {
            statusMsg.textContent = "暂时没有动态哦~";
            return;
          }

          statusMsg.style.display = 'none';
          renderMoments(data);
        })
        .catch(err => {
          console.error('加载动态失败:', err);
          loadingOverlay.classList.remove('show');
          statusMsg.innerHTML = `加载失败，请<a href="javascript:location.reload()" style="color:var(--primary-color)">刷新</a>重试`;
        });

      // 渲染函数
      function renderMoments(moments) {
        // 按日期倒序排列
        moments.sort((a, b) => new Date(b.date) - new Date(a.date));

        moments.forEach((item, index) => {
          const card = document.createElement('div');
          card.className = 'moment-card';
          // 设置动画延迟，形成阶梯出现效果
          card.style.animation = `blurFadeUp 0.8s ease forwards ${index * 0.15}s`;

          // 处理图片 HTML
          let imagesHtml = '';
          if (item.images && item.images.length > 0) {
            const count = item.images.length;
            // 根据数量设置 data-count 用于 CSS Grid 布局
            const gridClass = count <= 4 ? count : 'default';
            
            imagesHtml = `<div class="moment-gallery" data-count="${gridClass}">`;
            item.images.forEach(src => {
              // 懒加载 loading="lazy"
              const isPotentialMotion = /\.(jpg|jpeg|heic)$/i.test(src);
              const badgeHtml = isPotentialMotion 
                ? `<div class="live-badge" onclick="playMotionPhoto(this, '${src}')" title="播放动态照片">
                     <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg> LIVE
                   </div>` 
                : '';

              imagesHtml += `
                <div class="moment-img-wrapper">
                  <img src="${src}" alt="动态图片" loading="lazy">
                  ${badgeHtml}
                </div>
              `;
            });
            imagesHtml += `</div>`;
          }

          // 构建卡片 HTML
          card.innerHTML = `
            <div class="moment-header">
              <img src="/favicon.ico" class="moment-avatar" alt="Avatar">
              <div class="moment-info">
                <span class="moment-author">缎金SatinAu</span>
                <span class="moment-date">${formatDate(item.date)}</span>
              </div>
            </div>
            <div class="moment-content">${marked.parse(item.content).replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ')}</div>
            ${imagesHtml}
          `;

          momentsList.appendChild(card);
        });

        // 初始化图片查看器
        initViewer();
      }

      // 日期格式化 (YYYY年MM月DD日 HH:mm)
      function formatDate(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const formatConfig = date.getFullYear() === now.getFullYear() 
          ? { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }
          : { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' };
        return date.toLocaleString('zh-CN', formatConfig).replace(/\//g, '-');
      }

      // 初始化 Viewer.js
      function initViewer() {
        const galleries = document.querySelectorAll('.moment-gallery');
        galleries.forEach(gallery => {
          new Viewer(gallery, {
            toolbar: {
              zoomIn: 1,
              zoomOut: 1,
              oneToOne: 1,
              reset: 1,
              prev: 1,
              play: 1,
              next: 1,
              rotateLeft: 1,
              rotateRight: 1,
              flipHorizontal: 1,
              flipVertical: 1,
            },
            navbar: true,
            title: false,
            transition: true
          });
        });
      }
    });
  </script>
  
  <!-- 弹窗组件 -->
  <global-modal id="globalModal"></global-modal>

</body>

<!-- Cookie Consent by TermsFeed https://www.TermsFeed.com -->
<script type="text/javascript" src="https://www.termsfeed.com/public/cookie-consent/4.2.0/cookie-consent.js" charset="UTF-8"></script>
<script type="text/javascript" charset="UTF-8">
document.addEventListener('DOMContentLoaded', function () {
cookieconsent.run({"notice_banner_type":"simple","consent_type":"express","palette":"light","language":"en","page_load_consent_levels":["strictly-necessary"],"notice_banner_reject_button_hide":false,"preferences_center_close_button_hide":false,"page_refresh_confirmation_buttons":false,"website_name":"缎金SatinAu","website_privacy_policy_url":"https://satinau.cn/pages/agreement"});
});
</script>

<!-- Microsoft Clarity -->
<script type="text/plain" data-cookie-consent="tracking">
    (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
    })(window, document, "clarity", "script", "trwlkhxzch");
</script>
<!-- end of Microsoft Clarity-->

<noscript>Free cookie consent management tool by <a href="https://www.termsfeed.com/">TermsFeed</a></noscript>
<!-- End Cookie Consent by TermsFeed https://www.TermsFeed.com -->

</html>